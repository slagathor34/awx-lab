---
- name: Ensure user is present with address information
  community.windows.win_domain_user:
    name: "{{ username }}"
    firstname: "{{ first_name }}"
    surname: "{{ last_name }}"
    company: BSC
    password: "{{ password }}"
    state: present
    groups:
      - Domain Users
    street: "{{ street_address }}"
    city: "{{ city }}"
    state_province: "{{ state }}"
    postal_code: "{{ zip_code }}"
    country: US
    attributes:
      telephoneNumber: "{{ phone_number }}"
  tags: CreateUser

- name: Delete AD User
  community.windows.win_domain_user:
    name: "{{ username }}"
    firstname: "{{ first_name }}"
    surname: "{{ last_name }}"
    state: absent
  tags: DeleteUser

- name: Ensure the group exists using sAMAccountName
  community.windows.win_domain_group:
    name: "{{ group_name }}"
    scope: global
    path: CN=Builtin,DC=brainstormes,DC=org
    state: present
  tags: CreateGroup

- name: Delete a group using sAMAccountName
  community.windows.win_domain_group:
    name: "{{ group_name }}"
    scope: global
    path: CN=Builtin,DC=brainstormes,DC=org
    state: absent
  tags: DeleteGroup

- name: Add a domain user/group to a domain group
  community.windows.win_domain_group_membership:
    name: "{{ group_name }}"
    members:
      - "{{ username }}"
    state: present
  tags: AddUserToGroup

- name: Remove a domain user/group to a domain group
  community.windows.win_domain_group_membership:
    name: "{{ group_name }}"
    members:
      - "{{ username }}"
    state: absent
  tags: RemoveUserFromGroup

- name: Get all properties for the specified account using its DistinguishedName
  community.windows.win_domain_object_info:
    identity: "CN={{ username }},CN=Users,DC=brainstormes,DC=org"
    properties: '*'
  tags: GetUserProperties

- name: Get all properties for the specified account using its DistinguishedName
  community.windows.win_domain_object_info:
    identity: "CN={{ group_name }},CN=Builtin,DC=brainstormes,DC=org"
    properties: '*'
  tags: GetGroupProperties

- name: Manage Azure AD Group
  azure.azcollection.azure_rm_adgroup:
    tenant: "{{ aad_tenant_id }}"
    display_name: "{{ aad_group_name }}"
    mail_nickname: "{{ aad_mail_group_nickname }}"
    state: "{{ aad_action }}"
  tags: ManageAADGroup

- name: Manage Azure AD User
  azure.azcollection.azure_rm_aduser:
    user_principal_name: "{{ user_id }}"
    tenant: "{{ tenant_id }}"
    state: "{{ aad_action }}"
    account_enabled: "True"
    display_name: "{{ user_principal_name }}"
    password_profile: "password"
    mail_nickname: "{{ user_principal_name }}_mail_nickname"
    immutable_id: "{{ object_id }}"
    given_name: "{{ first_name }}"
    surname: "{{ last_name }}"
    user_type: "Member"
    usage_location: "US"
    mail: "{{ user_principal_name }}@stormesfamily.org"
  tags: ManageAADUser

- name: Get user_principal_name
  azure.azcollection.azure_rm_aduser_info:
    user_principal_name: "{{ username }}@brainstormes.org"
    tenant: "{{ tenant_id }}"
  register: username_object
  tags: TestUserObjectName

- name: Ensure a User is a Member of a Group using display_name and mail_nickname
  azure_rm_adgroup:
    tenant: "{{ tenant_id }}"
    display_name: "{{ aad_group_name }}"
    mail_nickname: "{{ aad_mail_group_nickname }}"
    state: 'present'
    present_members:
      - "https://graph.windows.net/{{ tenant_id }}/directoryObjects/{{ ad_object_1_object_id }}"